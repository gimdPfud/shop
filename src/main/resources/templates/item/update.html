<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <title>상품 정보 수정</title>
</head>
<body>
    <th:block layout:fragment="content">
        
        <form action="/admin/item/update" method="post" enctype="multipart/form-data" th:object="${itemDTO}">

            <!--todo 버튼들 !!!!!-->


            <div class="row m-4">
                <div class="col-10 offset-1">

                    <div class="row row-cols-3">
                        <div class="col-3">
                            <a href="/admin/item/list">
                                <button type="button" class="btn btn-dark">목록</button>
                            </a>
                        </div>
                        <div class="col-6">
                            <h1 class="text-center">상품 정보 수정</h1>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-dark">저장</button>
                        </div>
                    </div>

                    <div class="row row-cols-md-2 row-cols-1">
                        
                        <div class="col">
                            <th:block th:each="imgDTO : ${itemDTO.imageDTOList}">
                                <th:block th:if="${imgDTO.repimgYn=='Y'}">
                                    <img class="oldmain" th:src="${'/images/'+imgDTO.imgName}" style="max-width: 100%; height: auto;">
                                </th:block>
                            </th:block>
                            
                            
                            <div class="row">
                                <div class="mb-3 imgA">
                                    <label for="formFileLg1" class="form-label">대표이미지</label>
                                    <input name="newmainimg" class="form-control form-control-lg mainimg imgInput" id="formFileLg1" type="file">
                                </div>
                            </div>
                            
                            <div class="row main imgpreview"></div>
                            
                        </div>
                        
                        <div class="col">
                            
                            <div class="card border-dark">
                                <div class="card-body">
                                    
                                    <div class="row mb-3">
                                        <div class="col-4">
                                            <select class="form-select" th:field="*{itemSellStatus}" aria-label="Default select example">
                                                <option value="SELL">판매중</option>
                                                <option value="SOLD_OUT">품절</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <label for="item_id" class="col-4 col-form-label">상품번호</label>
                                        <div class="col-8">
                                            <input type="text" class="form-control-plaintext" id="item_id" th:field="*{id}" readonly>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <label for="itemNm" class="col-4 col-form-label">상품명</label>
                                        <div class="col-8">
                                            <input type="text" class="form-control" id="itemNm" th:field="*{itemNm}">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <label for="price" class="col-4 col-form-label">가격</label>
                                        <div class="col-8">
                                            <input type="text" class="form-control" id="price" th:field="*{price}">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <label for="stockNumber" class="col-4 col-form-label">재고수량</label>
                                        <div class="col-8">
                                            <input type="text" class="form-control" id="stockNumber" th:field="*{stockNumber}">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-4">등록시간</div>
                                        <div class="col" th:text="${#temporals.format(itemDTO.regTime,'yyyy-MM-dd HH:mm:ss')}"></div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-4">수정시간</div>
                                        <div class="col" th:text="${#temporals.format(itemDTO.updateTime,'yyyy-MM-dd HH:mm:ss')}"></div>
                                    </div>
                                
                                </div>
                            </div>
                            
                        </div>
                    </div><!--row-->
                    
                    <div class="row">
                        <div class="col">
                            
                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">
                                        상세보기</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">
                                        리뷰</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact-tab-pane" type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">
                                        Contact</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="disabled-tab" data-bs-toggle="tab" data-bs-target="#disabled-tab-pane" type="button" role="tab" aria-controls="disabled-tab-pane" aria-selected="false">
                                        Disabled</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="myTabContent">
                                <div class="row tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                                    <div class="row">
                                        <div class="col">
                                            <div class="card border-dark">
                                                <div class="card-body">
                                                    <textarea class="form-control" aria-label="With textarea" th:field="*{itemDetail}"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="mb-3 imgA">
                                            <label for="formFileLg2" class="form-label">상세이미지</label>
                                            <input name="mutipartFile" class="form-control form-control-lg imgInput" id="formFileLg2" type="file">
                                        </div>
                                    </div>

                                    <div class="row showimg">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="row row-cols-1 row-cols-md-3 imgd imgpreview"></div>
                                            </div>
                                        </div>
                                    </div>


                                    
                                    <th:block th:each="imgDTO : ${itemDTO.imageDTOList}">
                                        <div class="row" th:if="${imgDTO.repimgYn != 'Y'}">
                                            <div class="col position-relative m-3">
                                                <img th:data-imgid="${imgDTO.id}" th:src="${'/images/'+imgDTO.imgName}" style="max-width: 100%; height: auto;" th:alt="${imgDTO.oriImgName}">
                                                <button type="button" class="old-detail-img-btn btn btn-dark position-absolute top-0 end-0">삭제</button>
                                            </div>
                                        </div>
                                    </th:block>
                                </div>
                                <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0"
                                     th:text="${itemDTO.itemDetail}"></div>
                                <div class="tab-pane fade" id="contact-tab-pane" role="tabpanel" aria-labelledby="contact-tab" tabindex="0">...</div>
                                <div class="tab-pane fade" id="disabled-tab-pane" role="tabpanel" aria-labelledby="disabled-tab" tabindex="0">...</div>
                            </div>
                        
                        </div>
                    </div>
                
                
                
                </div>
            </div>
        </form>
        
        <th:block layout:fragment="script">
            <script th:inline="javascript">
                $(document).ready(function (){
                    
                    let imgA = $(".imgA")
                    let olddimgbtn = $(".old-detail-img-btn")
                    $(".showimg").hide()

                    /*todo 상세이미지 삭제 버튼 클릭 시*/
                    olddimgbtn.on("click", function () {
                        $(this).parent().parent().hide()
                        let imgid = $(this).parent().find("img").data("imgid")
                        // console.log(imgid)
                        let str = `<input type="text" name="delino" value="${imgid}">`
                        $(this).parent().parent().append(str)
                    })
                    
                    /*todo input type:file에 대한 이벤트*/
                    imgA.on("change", "input", function () {
                        // 파일 유효성 검사
                        let fileName = $(this).val().split("\\").pop()/*파일 이름*/
                        let fileExt = fileName.substring(fileName.lastIndexOf(".")+1)/*파일 확장자*/
                        fileExt = fileExt.toLowerCase()
                        if(fileExt != "jpg" && fileExt !="jpeg" && fileExt !="png" && fileExt != "gif" && fileExt !="bmp"){
                            $(this).val("")
                            alert("이미지 파일만 넣어주세요.")
                            return false;
                        }
                        
                        if(this.classList.contains("mainimg")){
                            /*클래스 중 mainimg가 있다면...*/
                            /*대표이미지 미리보기*/
                            readURLMain(this)
                        }else{
                            /*상세이미지 미리보기*/
                            readURL(this)
                        }
                    })
                    
                    /*todo 미리보기 대표*/
                    function readURLMain( input ) {
                        if(input.files && input.files[0]){
                            let reader = new FileReader();
                            reader.onload = function (e) {
                                let inputtag = document.createElement("input")
                                inputtag.type = "file";
                                inputtag.name = "mainimg";
                                
                                const dataTransfer = new DataTransfer();
                                const fileDatas = Array.from(input.files);
                                
                                fileDatas.forEach(file => dataTransfer.items.add(file))
                                
                                inputtag.files = dataTransfer.files;
                                
                                let str1 = `<div class="preview col position-relative">
<img  style="max-width: 30%; height: auto;" src="${e.target.result}"><button type="button" class="mainimgbtn btn btn-dark position-absolute top-0 end-0">올리지 않기</button></div>`
                                
                                $(".main").html(str1)
                                $(".main").find('div:eq(0)').append(inputtag)
                                $(".main").find('input').hide()
                                $(".imgInput").val('')
                                $(".oldmain").hide()
                                
                            }
                            reader.readAsDataURL(input.files[0])
                        }
                    }
                    
                    /*todo 미리보기 상세*/
                    function readURL(input) {
                        if(input.files && input.files[0]){
                            let reader = new FileReader();
                            reader.onload = function (e) {
                                let inputtag = document.createElement("input")
                                inputtag.type = "file";
                                inputtag.name = "multipartFile";
                                
                                const dataTransfer = new DataTransfer();
                                const fileDatas = Array.from(input.files);
                                
                                fileDatas.forEach(file => dataTransfer.items.add(file))
                                
                                inputtag.files = dataTransfer.files;
                                
                                let str1 = `<div class="preview col position-relative">
<img width="100%" src="${e.target.result}">
<button type="button" class="detailbtn btn btn-dark position-absolute top-0 end-0">올리지 않기</button>
</div>`
                                
                                $(".imgd").prepend(str1)/*추가할 때 마다 뒤로 밀려나서 신선한게 앞으로..ㅋㅋ*/
                                $(".imgd").find('div:eq(0)').append(inputtag)
                                $(".imgd").find('input').hide()
                                $(".imgInput").val('')
                                $(".showimg").show()
                                
                            }
                            reader.readAsDataURL(input.files[0])
                        }
                    }

                    /*올리지않기 버튼*/
                    $(".imgpreview").on("click","button",function () {
                        /*만약 누른 버튼이 메인의 버튼이라면??*/
                        if(this.classList.contains("mainimgbtn")){
                            $(".oldmain").show() /*보이기^_^*/
                        }
                        $(this).parent().remove()
                    })

                })
            </script>
        </th:block>
        
    </th:block>
</body>
</html>